<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <div th:replace="~{comlayout/base :: meta}"></div>
  <div th:replace="~{comlayout/base :: styles}"></div>
  <title>ã‚«ãƒ¼ãƒˆ | HealSweets</title>
</head>
<body>
  <div th:replace="~{comlayout/base :: header}"></div>
  
  <main id="cart" class="container">
    <h2 style="color: #6d4c41; text-align: center; margin-top: 30px;">ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆ</h2>
    
    <p th:if="${#lists.isEmpty(cart)}" class="cart-empty-message" style="text-align: center; padding: 50px;">
      ã‚«ãƒ¼ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
    </p>

    <div th:unless="${#lists.isEmpty(cart)}">
      <form th:action="@{/cart/update}" method="post">
        <table class="cart-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
          <thead>
            <tr style="border-bottom: 2px solid #eee; background-color: #f9f9f9; text-align: center;">
              <th colspan="2" style="padding: 10px;">å•†å“</th>
              <th>å€¤æ®µ (ç¨è¾¼)</th>
              <th>å€‹æ•°</th>
              <th>åˆè¨ˆ (ç¨è¾¼)</th>
              <th>Gift</th>
              <th>å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="item : ${cart}" th:data-product-id="${item.product.productId}" class="cart-item-row" style="border-bottom: 1px solid #eee;">
              <td style="padding: 15px; width: 100px;">
                <img th:src="@{${item.product.imagePath}}" 
                     th:alt="${item.product.productName}" 
                     style="width: 80px; border-radius: 8px;">
              </td>
              <td th:text="${item.product.productName}" style="font-weight: bold; padding: 10px;">å•†å“å</td>
              
              <td style="text-align: center;">
                <span class="item-price"
                      th:text="${#numbers.formatInteger(item.product.price, 1, 'COMMA')} + 'å††'"
                      th:data-price="${item.product.price}">0å††</span>
              </td>
              
              <td style="text-align: center;">
                <div class="quantity-control" style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                    <input type="number" name="quantity" 
                           class="item-quantity"
                           th:value="${item.count}" min="1" max="99"
                           style="width: 50px; text-align: center;">
                    <input type="hidden" name="productId" th:value="${item.product.productId}">
                </div>
              </td>
              
              <td style="text-align: center;">
                <span class="item-subtotal"
                      th:text="${#numbers.formatInteger(item.product.price * item.count, 1, 'COMMA')} + 'å††'">0å††</span>
              </td>

              <td style="text-align: center;">
                  <input type="checkbox" name="giftProductIds" 
                         th:value="${item.product.productId}" 
                         th:checked="${item.gift}">
              </td>
              
              <td style="text-align: center;">
                <a th:href="@{/cart/remove(id=${item.product.productId})}" 
                   onclick="return confirm('ã“ã®å•†å“ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')"
                   style="text-decoration: none; font-size: 1.5rem;">
                   ğŸ—‘ï¸
                </a>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr style="background-color: #fdf5e6; font-weight: bold;">
              <td colspan="4" style="text-align: right; padding: 15px;">å•†å“åˆè¨ˆé‡‘é¡ (ç¨è¾¼):</td>
              <td colspan="3" style="padding: 15px; color: #d32f2f; font-size: 1.2em;">
                <span id="total-price" th:text="${#numbers.formatInteger(totalPrice, 1, 'COMMA')} + 'å††'">0å††</span>
              </td>
            </tr>
          </tfoot>
        </table>
        
        <div style="text-align: right; margin-top: 20px;">
          <button type="submit" class="update-button" style="background-color: #8d6e63; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            æ•°é‡ãƒ»ã‚®ãƒ•ãƒˆè¨­å®šã‚’æ›´æ–°ã™ã‚‹
          </button>
        </div>
      </form>

      <div class="button-group" style="display: flex; justify-content: space-between; margin-top: 40px; margin-bottom: 50px;">
        <a th:href="@{/}" class="continue-shopping-button" style="text-decoration: none; color: #6d4c41; padding: 10px 20px; border: 1px solid #6d4c41; border-radius: 5px;">è²·ã„ç‰©ã‚’ç¶šã‘ã‚‹</a>
        <a th:href="@{/purchase/input}" class="checkout-button" style="text-decoration: none; background-color: #4caf50; color: white; padding: 10px 30px; border-radius: 5px; font-weight: bold;">è³¼å…¥ç”»é¢ã¸é€²ã‚€</a>
      </div>
    </div>
  </main>
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
      // å…¨ã¦ã®æ•°é‡å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const quantityInputs = document.querySelectorAll('.item-quantity');
      
      quantityInputs.forEach(function(input) {
          input.addEventListener('change', updateCart);
          input.addEventListener('input', updateCart);
      });
  });

  function updateCart() {
      let totalPrice = 0;
      
      // å…¨ã¦ã®å•†å“è¡Œã‚’å–å¾—
      const rows = document.querySelectorAll('.cart-item-row');
      
      rows.forEach(function(row) {
          const priceSpan = row.querySelector('.item-price');
          const quantityInput = row.querySelector('.item-quantity');
          const subtotalSpan = row.querySelector('.item-subtotal');
          
          // å˜ä¾¡ã‚’å–å¾—
          const price = parseInt(priceSpan.getAttribute('data-price'));
          // æ•°é‡ã‚’å–å¾—ï¼ˆ1æœªæº€ã®å ´åˆã¯1ã«ï¼‰
          let quantity = parseInt(quantityInput.value);
          if (isNaN(quantity) || quantity < 1) {
              quantity = 1;
              quantityInput.value = 1;
          }
          if (quantity > 99) {
              quantity = 99;
              quantityInput.value = 99;
          }
          
          // å°è¨ˆã‚’è¨ˆç®—
          const subtotal = price * quantity;
          
          // å°è¨ˆã‚’è¡¨ç¤º
          subtotalSpan.textContent = subtotal.toLocaleString() + 'å††';
          
          // åˆè¨ˆã«åŠ ç®—
          totalPrice += subtotal;
      });
      
      // åˆè¨ˆé‡‘é¡ã‚’è¡¨ç¤º
      const totalPriceSpan = document.getElementById('total-price');
      if (totalPriceSpan) {
          totalPriceSpan.textContent = totalPrice.toLocaleString() + 'å††';
      }
  }
  </script>
  <div th:replace="~{comlayout/base :: footer}"></div>
</body>
</html>
