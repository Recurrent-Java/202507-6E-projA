<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <div th:replace="~{comlayout/base :: meta}"></div>
  <div th:replace="~{comlayout/base :: styles}"></div>
  <link rel="icon" href="data:,">
  <meta name="_csrf" th:content="${_csrf?.token}" />
  <meta name="_csrf_header" th:content="${_csrf?.headerName}" />
  <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ - HealSweets</title>
</head>

<body>
  <div th:replace="~{comlayout/base :: header}"></div>
  <div th:replace="~{comlayout/base :: nav}"></div>

  <main class="mypage-container" style="margin-top: 40px; margin-bottom: 60px;">
    <div class="welcome-header">
      <h1>ã‚ˆã†ã“ãã€<span th:text="${member.fullName}">é–¢å±‹ é›„ä¸€éƒ</span> æ§˜</h1>
    </div>

    <div th:if="${successMessage}" class="alert alert-success"
      style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
      <span th:text="${successMessage}"></span>
    </div>

    <div class="mypage-wrapper">
      <aside class="sidebar-menu">
        <div class="menu-item active" data-section="rank"><span class="menu-icon">ğŸ‘‘</span> ãƒ©ãƒ³ã‚¯ãƒ»ãƒã‚¤ãƒ³ãƒˆæƒ…å ±</div>
        <div class="menu-item" data-section="orders"><span class="menu-icon">ğŸ“¦</span> æ³¨æ–‡ãƒ»é…é€å±¥æ­´</div>
        <div class="menu-item" data-section="info"><span class="menu-icon">ğŸ‘¤</span> ä¼šå“¡æƒ…å ±ç·¨é›†</div>
        <div class="menu-item" data-section="allergy"><span class="menu-icon">ğŸ¥—</span> ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç™»éŒ²</div>
        <div class="menu-item" data-section="withdrawal"><span class="menu-icon">âš ï¸</span> é€€ä¼šæ‰‹ç¶šã</div>
        <a th:href="@{/contact}" class="menu-item external-link"><span class="menu-icon">âœ‰ï¸</span> ãŠå•ã„åˆã‚ã› (åˆ¥çª“)</a>
      </aside>

      <section class="main-content-area">

        <div class="content-section active" id="rank">
          <h2>ä¼šå“¡ãƒ©ãƒ³ã‚¯æƒ…å ±</h2>
          <div class="rank-card">
            <div class="current-rank">
              <span class="rank-icon" th:utext="${member.currentRank.iconHtml}">ğŸª</span>
              <h3 th:text="${member.currentRank.rankName}">ãƒ©ãƒ³ã‚¯å</h3>
              <p>ç¾åœ¨ã®å¹´é–“ç´¯ç©è³¼å…¥é‡‘é¡: <strong
                  th:text="${#numbers.formatDecimal(member.annualSpending, 0, 'COMMA', 0, 'POINT')} + 'å††'">0å††</strong>
              </p>
            </div>
            <div th:if="${member.nextRank}" class="progress-section">
              <h4>æ¬¡ã®ãƒ©ãƒ³ã‚¯ã¾ã§ã‚ã¨å°‘ã—ï¼</h4>
              <p
                th:text="${member.nextRank.rankName} + ' é”æˆã¾ã§ ' + ${#numbers.formatDecimal(member.spendingToNextRank, 0, 'COMMA', 0, 'POINT')} + 'å††'">
              </p>
              <div class="progress-bar-container">
                <div class="progress-bar" th:style="'width: ' + ${member.rankProgressPercent} + '%'"></div>
              </div>
            </div>
          </div>
          <h3>ä¿æœ‰ãƒã‚¤ãƒ³ãƒˆ</h3>
          <div class="point-info-card">
            <p>åˆ©ç”¨å¯èƒ½ãƒã‚¤ãƒ³ãƒˆ: <strong
                th:text="${#numbers.formatDecimal(member.availablePoints, 0, 'COMMA', 0, 'POINT')} + ' pt'">0
                pt</strong></p>
          </div>
        </div>

        <div class="content-section" id="orders">
          <h2>æ³¨æ–‡å±¥æ­´</h2>
          <table class="order-table" th:if="${!#lists.isEmpty(orders)}">
            <thead>
              <tr>
                <th>æ³¨æ–‡ID</th>
                <th>æ³¨æ–‡æ—¥æ™‚</th>
                <th>åˆè¨ˆé‡‘é¡</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>è©³ç´°</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="order : ${orders}">
                <td th:text="${order.orderId}"></td>
                <td th:text="${#temporals.format(order.orderDate, 'yyyy/MM/dd HH:mm')}"></td>
                <td th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + 'å††'"></td>
                <td th:text="${order.status}"></td>
                <td><a th:href="@{/mypage/order_detail(id=${order.orderId})}" class="detail-link">è©³ç´°ã‚’è¦‹ã‚‹</a></td>
              </tr>
            </tbody>
          </table>
          <p th:if="${#lists.isEmpty(orders)}">éå»ã®æ³¨æ–‡å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>

        <div class="content-section" id="info">
          <h2>ğŸ‘¤ ä¼šå“¡æƒ…å ±ç·¨é›†</h2>
          <p class="section-desc">ã”ç™»éŒ²æƒ…å ±ã®ç¢ºèªã¨å¤‰æ›´ãŒå¯èƒ½ã§ã™ã€‚</p>

          <form th:action="@{/mypage/update_info}" method="post">
            <div class="info-form-grid">
              <div class="form-group full-width">
                <label>æ°åï¼ˆæ¼¢å­—ï¼‰</label>
                <input type="text" name="fullName" th:value="${member.fullName}" class="form-input">
              </div>

              <div class="form-group">
                <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" th:value="${member.email}" class="form-input" readonly
                  style="background-color: #f0f0f0; cursor: not-allowed;">
                <small>â€»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</small>
              </div>
              <div class="form-group">
                <label>é›»è©±ç•ªå·</label>
                <input type="tel" name="phoneNumber" th:value="${member.phoneNumber}" class="form-input"
                  placeholder="09012345678">
              </div>

              <div class="form-group">
                <label>éƒµä¾¿ç•ªå·</label>
                <input type="text" name="postalCode" th:value="${member.postalCode}" class="form-input"
                  placeholder="1234567">
              </div>
              <div class="form-group">
                <label>éƒ½é“åºœçœŒ</label>
                <input type="text" name="prefecture" th:value="${member.prefecture}" class="form-input">
              </div>

              <div class="form-group full-width">
                <label>å¸‚åŒºç”ºæ‘ãƒ»ç•ªåœ° (ä½æ‰€1)</label>
                <input type="text" name="addressLine1" th:value="${member.addressLine1}" class="form-input">
              </div>

              <div class="form-group full-width">
                <label>å»ºç‰©åãƒ»å·å®¤ (ä½æ‰€2)</label>
                <input type="text" name="addressLine2" th:value="${member.addressLine2}" class="form-input">
              </div>
            </div>

            <button type="submit" class="submit-btn">å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹</button>
          </form>

          <div class="action-card mt-4"
            style="background: #fff5f5; padding: 20px; border-radius: 12px; border: 1px solid #ffe3e3;">
            <h3 style="color: #c53030;">ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</h3>
            <p>ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã¯ã“ã¡ã‚‰ã‹ã‚‰è¡Œãˆã¾ã™ã€‚</p>
            <a th:href="@{/mypage/change_password}" class="danger-link"
              style="color: #c53030; font-weight: bold;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ ï¼</a>
          </div>
        </div>

        <div class="content-section" id="allergy">
          <h2>ğŸš« ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ç™»éŒ²</h2>
          <p>ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼:</p>
          <div class="allergy-tags" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
            <span class="allergy-tag" th:each="name : ${registeredAllergenNames}"
              style="background: #ffe3e3; padding: 5px 12px; border-radius: 20px; border: 1px solid #ffc1c1; color: #c53030; font-weight: bold;">
              <span th:text="${name}"></span>
            </span>
            <p th:if="${#lists.isEmpty(registeredAllergenNames)}">æœªç™»éŒ²</p>
          </div>

          <div class="allergy-form mt-4">
            <h3>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼é …ç›®ã‚’ç·¨é›†</h3>
            <form th:action="@{/mypage/update_allergies}" method="post">
              <div class="checkbox-group"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                <label th:each="master : ${allergenMasters}" style="cursor: pointer;">
                  <input type="checkbox" name="allergenCode" th:value="${master.allergenCode}"
                    th:checked="${#lists.contains(member.allergens, master.allergenCode)}">
                  <span th:text="${master.allergenName}">åµ</span>
                </label>
              </div>
              <button type="submit" class="submit-btn" style="margin-top: 20px;">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹</button>
            </form>
          </div>
        </div>

        <div class="content-section" id="withdrawal">
          <div id="withdrawalFormContainer">
            <h2>é€€ä¼šæ‰‹ç¶šã</h2>
            <div class="warning-card">
              <ul class="warning-list">
                <li
                  th:text="|ä¿æœ‰ãƒã‚¤ãƒ³ãƒˆ: ${#numbers.formatDecimal(member.availablePoints, 0, 'COMMA', 0, 'POINT')}pt ãŒå¤±åŠ¹ã—ã¾ã™|">
                </li>
                <li>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™</li>
              </ul>
              <div class="withdrawal-form">
                <textarea class="withdrawal-reason" id="withdrawalReason" placeholder="é€€ä¼šç†ç”±ï¼ˆä»»æ„ï¼‰"></textarea>
                <label class="checkbox-item confirm-checkbox">
                  <input type="checkbox" id="confirm-withdrawal">
                  <span>ä¸Šè¨˜ã®å†…å®¹ã‚’ç†è§£ã—ã€é€€ä¼šã‚’å¸Œæœ›ã—ã¾ã™</span>
                </label>
                <button type="button" class="danger-btn" id="withdrawal-btn" disabled
                  onclick="openConfirmModal()">é€€ä¼šã™ã‚‹</button>
              </div>
            </div>
          </div>
          <div id="completionMessage" style="display: none;">
            <h1>ğŸ‰ é€€ä¼šå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ ğŸ‰</h1>
            <p>TOPç”»é¢ã¸æˆ»ã‚Šã¾ã™ã€‚ä»Šã¾ã§ã®ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</p>
          </div>
        </div>

      </section>
    </div>
  </main>

  <div id="finalConfirmModal" class="modal">
    <div class="modal-content"
      style="background: white; padding: 30px; border-radius: 15px; position: relative; z-index: 10001;">
      <h2 style="margin-top: 0; color: #333;">æœ€çµ‚ç¢ºèª</h2>
      <p style="color: #666; margin-bottom: 25px;">æœ¬å½“ã«é€€ä¼šã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
      <div class="modal-actions" style="display: flex; gap: 15px; justify-content: center;">
        <button type="button" class="submit-btn" onclick="executeWithdrawal()"
          style="margin-top: 0; width: auto; padding: 10px 30px;">ã¯ã„</button>
        <button type="button" class="danger-btn" onclick="closeModal('finalConfirmModal')"
          style="padding: 10px 30px; background-color: #666; color: white; border: none; border-radius: 8px; cursor: pointer;">ã„ã„ãˆ</button>
      </div>
    </div>
  </div>

  <div th:replace="~{comlayout/base :: footer}"></div>

  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      // ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ .mypage-wrapper å†…ã«é™å®šã—ã¦ç«¶åˆã‚’é¿ã‘ã‚‹
      const menuItems = document.querySelectorAll('.mypage-wrapper .menu-item');
      const contentSections = document.querySelectorAll('.mypage-wrapper .content-section');

      // --- è¿½åŠ ï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ­ã‚¸ãƒƒã‚¯ ---
      const urlParams = new URLSearchParams(window.location.search);
      const targetSection = urlParams.get('section'); // "info" ã‚„ "allergy" ã‚’å–å¾—

      if (targetSection) {
        // 1. å…¨ã¦ã® active ã‚¯ãƒ©ã‚¹ã‚’ä¸€æ—¦æ¶ˆã™
        menuItems.forEach(m => m.classList.remove('active'));
        contentSections.forEach(s => s.classList.remove('active'));

        // 2. è©²å½“ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’ active ã«ã™ã‚‹
        const targetMenu = document.querySelector(`.menu-item[data-section="${targetSection}"]`);
        if (targetMenu) targetMenu.classList.add('active');

        // 3. è©²å½“ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã‚’ active ã«ã™ã‚‹
        const targetContent = document.getElementById(targetSection);
        if (targetContent) targetContent.classList.add('active');
      }

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
      menuItems.forEach(item => {
        item.addEventListener('click', function () {
          const sectionId = this.getAttribute('data-section');
          if (!sectionId) return;

          // å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã® active ä»˜ã‘æ›¿ãˆ
          menuItems.forEach(m => m.classList.remove('active'));
          this.classList.add('active');

          // å³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã® active ä»˜ã‘æ›¿ãˆ
          contentSections.forEach(sec => {
            sec.classList.remove('active');
            if (sec.id === sectionId) sec.classList.add('active');
          });
        });
      });
      // é€€ä¼šåˆ¶å¾¡
      const confirmCheckbox = document.getElementById('confirm-withdrawal');
      const withdrawalBtn = document.getElementById('withdrawal-btn');
      if (confirmCheckbox) {
        confirmCheckbox.addEventListener('change', function () {
          withdrawalBtn.disabled = !this.checked;
        });
      }
    });

    // 1. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ä»˜ãï¼‰
    function openConfirmModal() {
      console.log("ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ");
      const modal = document.getElementById('finalConfirmModal');
      if (modal) {
        modal.style.setProperty('display', 'flex', 'important');
        console.log("displayã‚’flex(!important)ã«å¤‰æ›´ã—ã¾ã—ãŸ");
      } else {
        console.error("ID: finalConfirmModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      }
    }

    // 2. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'none';
    }

    // 3. é€€ä¼šã‚’å®Ÿéš›ã«å®Ÿè¡Œã™ã‚‹
    function executeWithdrawal() {
      console.log("é€€ä¼šå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™");

      closeModal('finalConfirmModal');

      const container = document.getElementById('withdrawalFormContainer');
      const message = document.getElementById('completionMessage');
      if (container) container.style.display = 'none';
      if (message) message.style.display = 'block';

      // é€ä¿¡ç”¨ãƒ•ã‚©ãƒ¼ãƒ ã®å‹•çš„ç”Ÿæˆ
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = /*[[@{/mypage/withdraw}]]*/ '/mypage/withdraw';

      // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã¨è¨­å®š
      const csrfTokenEl = document.querySelector('meta[name="_csrf"]');
      if (csrfTokenEl) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = '_csrf';
        input.value = csrfTokenEl.getAttribute('content');
        form.appendChild(input);
      }

      document.body.appendChild(form);
      console.log("ã‚µãƒ¼ãƒãƒ¼ã¸é€€ä¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™...");
      form.submit();
    }
  </script>
</body>

</html>