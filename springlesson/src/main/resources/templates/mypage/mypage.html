<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <div th:replace="~{comlayout/base :: meta}"></div>
  <div th:replace="~{comlayout/base :: styles}"></div>
  <link rel="icon" href="data:,">
  <meta name="_csrf" th:content="${_csrf?.token}" />
  <meta name="_csrf_header" th:content="${_csrf?.headerName}" />
  <title>マイページ - HealSweets</title>
</head>

<body>
  <div th:replace="~{comlayout/base :: header}"></div>
  <div th:replace="~{comlayout/base :: nav}"></div>

  <main class="mypage-container" style="margin-top: 40px; margin-bottom: 60px;">
    <div class="welcome-header">
      <h1>ようこそ、<span th:text="${member.fullName}">関屋 雄一郎</span> 様</h1>
    </div>

    <div th:if="${successMessage}" class="alert alert-success"
      style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
      <span th:text="${successMessage}"></span>
    </div>

    <div class="mypage-wrapper">
      <aside class="sidebar-menu">
        <div class="menu-item active" data-section="rank"><span class="menu-icon">👑</span> ランク・ポイント情報</div>
        <div class="menu-item" data-section="orders"><span class="menu-icon">📦</span> 注文・配送履歴</div>
        <div class="menu-item" data-section="info"><span class="menu-icon">👤</span> 会員情報編集</div>
        <div class="menu-item" data-section="allergy"><span class="menu-icon">🥗</span> アレルギー登録</div>
        <div class="menu-item" data-section="withdrawal"><span class="menu-icon">⚠️</span> 退会手続き</div>
        <a th:href="@{/contact}" class="menu-item external-link"><span class="menu-icon">✉️</span> お問い合わせ (別窓)</a>
      </aside>

      <section class="main-content-area">

        <div class="content-section active" id="rank">
          <h2>会員ランク情報</h2>
          <div class="rank-card">
            <div class="current-rank">
              <span class="rank-icon" th:utext="${member.currentRank.iconHtml}">🍪</span>
              <h3 th:text="${member.currentRank.rankName}">ランク名</h3>
              <p>現在の年間累積購入金額: <strong
                  th:text="${#numbers.formatDecimal(member.annualSpending, 0, 'COMMA', 0, 'POINT')} + '円'">0円</strong>
              </p>
            </div>
            <div th:if="${member.nextRank}" class="progress-section">
              <h4>次のランクまであと少し！</h4>
              <p
                th:text="${member.nextRank.rankName} + ' 達成まで ' + ${#numbers.formatDecimal(member.spendingToNextRank, 0, 'COMMA', 0, 'POINT')} + '円'">
              </p>
              <div class="progress-bar-container">
                <div class="progress-bar" th:style="'width: ' + ${member.rankProgressPercent} + '%'"></div>
              </div>
            </div>
          </div>
          <h3>保有ポイント</h3>
          <div class="point-info-card">
            <p>利用可能ポイント: <strong
                th:text="${#numbers.formatDecimal(member.availablePoints, 0, 'COMMA', 0, 'POINT')} + ' pt'">0
                pt</strong></p>
          </div>
        </div>

        <div class="content-section" id="orders">
          <h2>注文履歴</h2>
          <table class="order-table" th:if="${!#lists.isEmpty(orders)}">
            <thead>
              <tr>
                <th>注文ID</th>
                <th>注文日時</th>
                <th>合計金額</th>
                <th>ステータス</th>
                <th>詳細</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="order : ${orders}">
                <td th:text="${order.orderId}"></td>
                <td th:text="${#temporals.format(order.orderDate, 'yyyy/MM/dd HH:mm')}"></td>
                <td th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + '円'"></td>
                <td th:text="${order.status}"></td>
                <td><a th:href="@{/mypage/order_detail(id=${order.orderId})}" class="detail-link">詳細を見る</a></td>
              </tr>
            </tbody>
          </table>
          <p th:if="${#lists.isEmpty(orders)}">過去の注文履歴はありません。</p>
        </div>

        <div class="content-section" id="info">
          <h2>👤 会員情報編集</h2>
          <p class="section-desc">ご登録情報の確認と変更が可能です。</p>

          <form th:action="@{/mypage/update_info}" method="post">
            <div class="info-form-grid">
              <div class="form-group full-width">
                <label>氏名（漢字）</label>
                <input type="text" name="fullName" th:value="${member.fullName}" class="form-input">
              </div>

              <div class="form-group">
                <label>メールアドレス</label>
                <input type="email" th:value="${member.email}" class="form-input" readonly
                  style="background-color: #f0f0f0; cursor: not-allowed;">
                <small>※メールアドレスは変更できません</small>
              </div>
              <div class="form-group">
                <label>電話番号</label>
                <input type="tel" name="phoneNumber" th:value="${member.phoneNumber}" class="form-input"
                  placeholder="09012345678">
              </div>

              <div class="form-group">
                <label>郵便番号</label>
                <input type="text" id="postalCodeInput" name="postalCode" th:value="${member.postalCode}"
                  class="form-input" placeholder="123-4567" maxlength="8" oninput="formatPostalCode(this)">
              </div>
              <div class="form-group">
                <label>都道府県</label>
                <input type="text" name="prefecture" th:value="${member.prefecture}" class="form-input">
              </div>

              <div class="form-group full-width">
                <label>市区町村・番地 (住所1)</label>
                <input type="text" name="addressLine1" th:value="${member.addressLine1}" class="form-input">
              </div>

              <div class="form-group full-width">
                <label>建物名・号室 (住所2)</label>
                <input type="text" name="addressLine2" th:value="${member.addressLine2}" class="form-input">
              </div>
            </div>

            <button type="submit" class="submit-btn">変更を保存する</button>
          </form>

          <div class="action-card mt-4"
            style="background: #fff5f5; padding: 20px; border-radius: 12px; border: 1px solid #ffe3e3;">
            <h3 style="color: #c53030;">🔒 セキュリティ設定</h3>
            <p>ログインパスワードの変更はこちらから行えます。</p>
            <a th:href="@{/mypage/change_password}" class="danger-link"
              style="color: #c53030; font-weight: bold;">パスワードを変更する ＞</a>
          </div>
        </div>

        <div class="content-section" id="allergy">
          <h2>🚫 アレルギー登録</h2>
          <p>現在登録されているアレルギー:</p>
          <div class="allergy-tags" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
            <span class="allergy-tag" th:each="name : ${registeredAllergenNames}"
              style="background: #ffe3e3; padding: 5px 12px; border-radius: 20px; border: 1px solid #ffc1c1; color: #c53030; font-weight: bold;">
              <span th:text="${name}"></span>
            </span>
            <p th:if="${#lists.isEmpty(registeredAllergenNames)}">未登録</p>
          </div>

          <div class="allergy-form mt-4">
            <h3>アレルギー項目を編集</h3>
            <form th:action="@{/mypage/update_allergies}" method="post">
              <div class="checkbox-group"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                <label th:each="master : ${allergenMasters}" style="cursor: pointer;">
                  <input type="checkbox" name="allergenCode" th:value="${master.allergenCode}"
                    th:checked="${#lists.contains(member.allergens, master.allergenCode)}">
                  <span th:text="${master.allergenName}">卵</span>
                </label>
              </div>
              <button type="submit" class="submit-btn" style="margin-top: 20px;">アレルギー情報を更新する</button>
            </form>
          </div>
        </div>

        <div class="content-section" id="withdrawal">
          <div id="withdrawalFormContainer">
            <h2>退会手続き</h2>
            <div class="warning-card">
              <ul class="warning-list">
                <li
                  th:text="|保有ポイント: ${#numbers.formatDecimal(member.availablePoints, 0, 'COMMA', 0, 'POINT')}pt が失効します|">
                </li>
                <li>アカウント情報が完全に削除されます</li>
              </ul>
              <div class="withdrawal-form">
                <textarea name="withdrawalReason" 
                          class="withdrawal-reason-textarea" 
                          placeholder="退会理由（任意）"></textarea>
                <label class="checkbox-item confirm-checkbox">
                  <input type="checkbox" id="confirm-withdrawal">
                  <span>上記の内容を理解し、退会を希望します</span>
                </label>
                <button type="button" 
                        id="withdrawal-btn" 
                        onclick="openConfirmModal()" 
                        disabled>退会する</button>
              </div>
            </div>
          </div>
          <div id="completionMessage" style="display: none;">
            <h1>🎉 退会処理が完了しました 🎉</h1>
            <p>TOP画面へ戻ります。今までのご利用ありがとうございました。</p>
          </div>
        </div>

      </section>
    </div>
  </main>

  <div id="finalConfirmModal" class="modal">
    <div class="modal-content"
      style="background: white; padding: 30px; border-radius: 15px; position: relative; z-index: 10001;">
      <h2 style="margin-top: 0; color: #333;">最終確認</h2>
      <p style="color: #666; margin-bottom: 25px;">本当に退会してもよろしいですか？</p>
      <div class="modal-actions" style="display: flex; gap: 15px; justify-content: center;">
        <button type="button" class="submit-btn" onclick="executeWithdrawal()"
          style="margin-top: 0; width: auto; padding: 10px 30px;">はい</button>
        <button type="button" class="danger-btn" onclick="closeModal('finalConfirmModal')"
          style="padding: 10px 30px; background-color: #666; color: white; border: none; border-radius: 8px; cursor: pointer;">いいえ</button>
      </div>
    </div>
  </div>

  <div th:replace="~{comlayout/base :: footer}"></div>

  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
      // セレクタを .mypage-wrapper 内に限定して競合を避ける
      const menuItems = document.querySelectorAll('.mypage-wrapper .menu-item');
      const contentSections = document.querySelectorAll('.mypage-wrapper .content-section');

      // --- ここに追加！ (画面表示時の郵便番号整形) ---
      const pcInput = document.getElementById('postalCodeInput');
      if (pcInput && pcInput.value) {
        formatPostalCode(pcInput);
      }

      // --- 追加：URLパラメータからセクションを取得して切り替えるロジック ---
      const urlParams = new URLSearchParams(window.location.search);
      const targetSection = urlParams.get('section'); // "info" や "allergy" を取得

      if (targetSection) {
        // 1. 全ての active クラスを一旦消す
        menuItems.forEach(m => m.classList.remove('active'));
        contentSections.forEach(s => s.classList.remove('active'));

        // 2. 該当するメニュー項目を active にする
        const targetMenu = document.querySelector(`.menu-item[data-section="${targetSection}"]`);
        if (targetMenu) targetMenu.classList.add('active');

        // 3. 該当するコンテンツエリアを active にする
        const targetContent = document.getElementById(targetSection);
        if (targetContent) targetContent.classList.add('active');
      }

      // メニュー切り替えロジック
      menuItems.forEach(item => {
        item.addEventListener('click', function () {
          const sectionId = this.getAttribute('data-section');
          if (!sectionId) return;

          // 左メニューの active 付け替え
          menuItems.forEach(m => m.classList.remove('active'));
          this.classList.add('active');

          // 右コンテンツの active 付け替え
          contentSections.forEach(sec => {
            sec.classList.remove('active');
            if (sec.id === sectionId) sec.classList.add('active');
          });
        });
      });
      // 退会制御
      const confirmCheckbox = document.getElementById('confirm-withdrawal');
      const withdrawalBtn = document.getElementById('withdrawal-btn');
      if (confirmCheckbox) {
        confirmCheckbox.addEventListener('change', function () {
          withdrawalBtn.disabled = !this.checked;
        });
      }
    });

    // 1. モーダルを開く（デバッグログ付き）
    function openConfirmModal() {
      console.log("モーダルを開く関数が呼ばれました");
      const modal = document.getElementById('finalConfirmModal');
      if (modal) {
        modal.style.setProperty('display', 'flex', 'important');
        console.log("displayをflex(!important)に変更しました");
      } else {
        console.error("ID: finalConfirmModal が見つかりません");
      }
    }

    // 2. モーダルを閉じる
    function closeModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'none';
    }

    // --- ★ここに追加：郵便番号の自動ハイフン整形 ---
    function formatPostalCode(input) {
      // 数字以外を除去
      let value = input.value.replace(/\D/g, '');
      // 3文字目以降にハイフンを挿入（最大7桁の数字を想定）
      if (value.length > 3) {
        value = value.slice(0, 3) + '-' + value.slice(3, 7);
      }
      input.value = value;
    }

    // 3. 退会を実際に実行する
    function executeWithdrawal() {
      console.log("退会処理を開始します");

      closeModal('finalConfirmModal');

      const container = document.getElementById('withdrawalFormContainer');
      const message = document.getElementById('completionMessage');
      if (container) container.style.display = 'none';
      if (message) message.style.display = 'block';

      // 送信用フォームの動的生成
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = /*[[@{/mypage/withdraw}]]*/ '/mypage/withdraw';

      // CSRFトークンの取得と設定
      const csrfTokenEl = document.querySelector('meta[name="_csrf"]');
      if (csrfTokenEl) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = '_csrf';
        input.value = csrfTokenEl.getAttribute('content');
        form.appendChild(input);
      }

      document.body.appendChild(form);
      console.log("サーバーへ退会リクエストを送信します...");
      form.submit();
    }
  </script>
</body>

</html>