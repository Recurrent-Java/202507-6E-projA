<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <div th:replace="~{comlayout/base :: meta}"></div>
  <div th:replace="~{comlayout/base :: styles}"></div>
  <title>会員登録 - HealSweets</title>
</head>

<body>
  <div th:replace="~{comlayout/base :: header}"></div>

  <section class="register-section">
    <div class="container">
      <div class="register-container">
        <div class="register-header">
          <h1>会員登録</h1>
          <p>HealSweetsへようこそ！新規アカウントを作成してください。</p>
        </div>

        <form class="register-form" id="registerForm" th:action="@{/register/confirm}" th:object="${registerForm}"
          method="post">
          <div class="step-indicator">
            <div class="step active">
              <div class="step-number">1</div>
              <div class="step-label">基本情報</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
              <div class="step-number">2</div>
              <div class="step-label">住所情報</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
              <div class="step-number">3</div>
              <div class="step-label">アレルギー情報</div>
            </div>
          </div>

          <div class="form-step active" id="step1">
            <h2>基本情報の入力</h2>
            <div class="form-row">
              <div class="form-group">
                <label>姓 <span class="required">*</span></label>
                <input type="text" class="form-input" th:field="*{lastName}" required placeholder="山田">
              </div>
              <div class="form-group">
                <label>名 <span class="required">*</span></label>
                <input type="text" class="form-input" th:field="*{firstName}" required placeholder="太郎">
              </div>
            </div>

            <div class="form-group">
              <label>メールアドレス <span class="required">*</span></label>
              <input type="email" class="form-input" th:field="*{email}" required placeholder="example@email.com">
              <small class="form-hint">ログインIDとして使用されます</small>
            </div>

            <div class="form-group">
              <label>パスワード <span class="required">*</span></label>
              <div class="password-input-group">
                <input type="password" class="form-input password-field" id="registerPassword" th:field="*{password}"
                  required placeholder="8文字以上">
                <button type="button" class="password-toggle-btn" data-target="registerPassword" aria-label="パスワードを表示"
                  onclick="togglePasswordVisibility(this)">👁️</button>
              </div>
              <small class="form-hint">英数字を含む8文字以上で設定してください</small>
            </div>

            <div class="form-group">
              <label>パスワード（確認） <span class="required">*</span></label>
              <div class="password-input-group">
                <input type="password" class="form-input password-field" id="registerPasswordConfirm"
                  name="passwordConfirm" required placeholder="もう一度入力してください">
                <button type="button" class="password-toggle-btn" data-target="registerPasswordConfirm"
                  aria-label="パスワードを表示" onclick="togglePasswordVisibility(this)">👁️</button>
              </div>
            </div>

            <div class="form-group">
              <label>電話番号 <span class="required">*</span></label>
              <input type="tel" class="form-input" th:field="*{phone}" id="phone" required placeholder="090-1234-5678"
                maxlength="13">
              <small class="form-hint">ハイフンなしで入力すると自動でハイフンが入ります。</small>
            </div>

            <div class="form-group">
              <label>生年月日 <span class="required">*</span></label>
              <div class="birthdate-select-group">
                <select class="form-select" id="birthYear" th:field="*{birthYear}" required>
                  <option value="">年</option>
                </select>
                <label class="select-label">年</label>
                <select class="form-select" id="birthMonth" th:field="*{birthMonth}" required>
                  <option value="">月</option>
                </select>
                <label class="select-label">月</label>
                <select class="form-select" id="birthDay" th:field="*{birthDay}" required>
                  <option value="">日</option>
                </select>
                <label class="select-label">日</label>
              </div>
            </div>
            <button type="button" class="next-btn" onclick="nextStep(2)">次へ進む</button>
          </div>

          <div class="form-step" id="step2">
            <h2>住所情報の入力</h2>
            <div class="form-group">
              <label>郵便番号 <span class="required">*</span></label>
              <div class="postal-input-group">
                <input type="text" class="form-input" th:field="*{postalCode}" id="postalCode" required
                  placeholder="1234567" maxlength="7">
                <button type="button" class="search-btn" onclick="searchAddress()">住所検索</button>
              </div>
            </div>
            <div class="form-group">
              <label>都道府県 <span class="required">*</span></label>
              <select class="form-select" th:field="*{prefecture}" id="prefecture" required>
                <option value="">選択してください</option>
              </select>
            </div>
            <div class="form-group">
              <label>市区町村 <span class="required">*</span></label>
              <input type="text" class="form-input" th:field="*{city}" id="city" required placeholder="〇〇市〇〇区">
            </div>
            <div class="form-group">
              <label>番地 <span class="required">*</span></label>
              <input type="text" class="form-input" th:field="*{address1}" required placeholder="1-2-3">
            </div>
            <div class="form-group">
              <label>建物名・部屋番号</label>
              <input type="text" class="form-input" th:field="*{address2}" placeholder="〇〇マンション 101号室">
            </div>
            <div class="button-group">
              <button type="button" class="back-btn" onclick="prevStep(1)">戻る</button>
              <button type="button" class="next-btn" onclick="nextStep(3)">次へ進む</button>
            </div>
          </div>

          <div class="form-step" id="step3">
            <h2>アレルギー情報の登録</h2>
            <p class="step-description">該当するアレルギーがあれば選択してください（任意）</p>

            <div class="allergy-section">
              <h3>アレルギー品目（特定原材料8品目など）</h3>
              <div class="checkbox-grid">

                <label class="checkbox-card" for="allergy_egg">
                  <input type="checkbox" name="allergenCode" th:field="*{allergy}" value="EGG" id="allergy_egg"
                    style="display: none;">
                  <div class="checkbox-content">
                    <span class="allergy-icon">🥚</span>
                    <span class="allergy-name">卵</span>
                  </div>
                </label>

                <label class="checkbox-card" for="allergy_wheat">
                  <input type="checkbox" name="allergenCode" th:field="*{allergy}" value="WHEAT" id="allergy_wheat"
                    style="display: none;">
                  <div class="checkbox-content">
                    <span class="allergy-icon">🌾</span>
                    <span class="allergy-name">小麦</span>
                  </div>
                </label>

                <label class="checkbox-card" for="allergy_milk">
                  <input type="checkbox" name="allergenCode" th:field="*{allergy}" value="MILK" id="allergy_milk"
                    style="display: none;">
                  <div class="checkbox-content">
                    <span class="allergy-icon">🥛</span>
                    <span class="allergy-name">乳製品</span>
                  </div>
                </label>

                <label class="checkbox-card" for="allergy_soba">
                  <input type="checkbox" name="allergenCode" th:field="*{allergy}" value="SOBA" id="allergy_soba"
                    style="display: none;">
                  <div class="checkbox-content">
                    <span class="allergy-icon">🍜</span>
                    <span class="allergy-name">そば</span>
                  </div>
                </label>

                <label class="checkbox-card" for="allergy_peanuts">
                  <input type="checkbox" name="allergenCode" th:field="*{allergy}" value="PEANUT" id="allergy_peanuts"
                    style="display: none;">
                  <div class="checkbox-content">
                    <span class="allergy-icon">🥜</span>
                    <span class="allergy-name">落花生</span>
                  </div>
                </label>

                <label class="checkbox-card" for="allergy_shrimp">
                  <input type="checkbox" name="allergenCode" th:field="*{allergy}" value="SHRIMP" id="allergy_shrimp"
                    style="display: none;">
                  <div class="checkbox-content">
                    <span class="allergy-icon">🦐</span>
                    <span class="allergy-name">えび</span>
                  </div>
                </label>

                <label class="checkbox-card" for="allergy_crab">
                  <input type="checkbox" name="allergenCode" th:field="*{allergy}" value="CRAB" id="allergy_crab"
                    style="display: none;">
                  <div class="checkbox-content">
                    <span class="allergy-icon">🦀</span>
                    <span class="allergy-name">かに</span>
                  </div>
                </label>

                <label class="checkbox-card" for="allergy_almond">
                  <input type="checkbox" name="allergenCode" th:field="*{allergy}" value="ALMOND" id="allergy_almond"
                    style="display: none;">
                  <div class="checkbox-content">
                    <span class="allergy-icon">🫘</span>
                    <span class="allergy-name">アーモンド</span>
                  </div>
                </label>

              </div>
            </div>

            <div class="terms-section">
              <label class="checkbox-item terms-checkbox">
                <input type="checkbox" id="agreeTerms" required>
                <span><a href="#terms" target="_blank">利用規約</a>と<a href="#privacy" target="_blank">プライバシーポリシー</a>に同意します
                  <span class="required">*</span></span>
              </label>
              <label class="checkbox-item">
                <input type="checkbox" name="newsletter">
                <span>メールマガジンを受け取る（新商品やお得な情報をお届けします）</span>
              </label>
            </div>

            <div class="button-group">
              <button type="button" class="back-btn" onclick="prevStep(2)">戻る</button>
              <button type="submit" class="submit-btn">登録内容を確認する</button>
            </div>
          </div>
        </form>
        <div class="login-prompt">
          <p>すでにアカウントをお持ちの方は<a th:href="@{/login}">こちらからログイン</a></p>
        </div>
      </div>
    </div>
  </section>

  <div th:replace="~{comlayout/base :: footer}"></div>

  <script>
    // 以前のスクリプトをそのまま使用してください
    // （変更不要ですが、必ず DOMContentLoaded の中身が実行されるようにしてください）
    function updateStepIndicator(stepNumber) {
      document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
      document.getElementById('step' + stepNumber).classList.add('active');
      document.querySelectorAll('.step').forEach((step, index) => {
        if (index < stepNumber) step.classList.add('active');
        else step.classList.remove('active');
      });
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function nextStep(stepNumber) {
      const currentStep = document.querySelector('.form-step.active');
      const inputs = currentStep.querySelectorAll('input[required]:not([type="checkbox"]), select[required]');
      let isValid = true;
      inputs.forEach(input => {
        if (!input.value) {
          isValid = false;
          input.classList.add('error');
        } else {
          input.classList.remove('error');
        }
      });
      if (stepNumber === 2) {
        const password = document.getElementById('registerPassword').value;
        const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
        if (password !== passwordConfirm) {
          alert('パスワードが一致しません。');
          isValid = false;
        }
      }
      if (!isValid) {
        alert('必須項目を入力してください。');
        return;
      }
      updateStepIndicator(stepNumber);
    }

    function prevStep(stepNumber) {
      updateStepIndicator(stepNumber);
    }

    document.addEventListener('DOMContentLoaded', function () {
      const prefectures = ['北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県', '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県', '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県', '静岡県', '愛知県', '三重県', '滋賀県', '京都府', '大阪府', '兵庫県', '奈良県', '和歌山県', '鳥取県', '島根県', '岡山県', '広島県', '山口県', '徳島県', '香川県', '愛媛県', '高知県', '福岡県', '佐賀県', '長崎県', '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県'];
      const prefectureSelect = document.getElementById('prefecture');
      if (prefectureSelect) {
        prefectures.forEach(pref => {
          const option = document.createElement('option');
          option.value = pref;
          option.textContent = pref;
          prefectureSelect.appendChild(option);
        });
      }

      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('birthYear');
      const monthSelect = document.getElementById('birthMonth');
      const daySelect = document.getElementById('birthDay');

      if (yearSelect && monthSelect && daySelect) {
        for (let i = currentYear; i >= currentYear - 100; i--) {
          const option = document.createElement('option');
          option.value = i; option.textContent = i;
          yearSelect.appendChild(option);
        }
        for (let i = 1; i <= 12; i++) {
          const option = document.createElement('option');
          option.value = i; option.textContent = i;
          monthSelect.appendChild(option);
        }
        for (let i = 1; i <= 31; i++) {
          const option = document.createElement('option');
          option.value = i; option.textContent = i;
          daySelect.appendChild(option);
        }
      }
    });

    async function searchAddress() {
      const postalCode = document.getElementById('postalCode').value.replace(/[^0-9]/g, '');

      if (postalCode.length !== 7) {
        alert('郵便番号は7桁で入力してください。');
        return;
      }

      try {
        // zipcloudのAPIを使用して住所を取得
        const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
        const data = await response.json();

        if (data.results) {
          const result = data.results[0];
          // 都道府県をセット
          document.getElementById('prefecture').value = result.address1;
          // 市区町村（address2）と町域（address3）を組み合わせてセット
          document.getElementById('city').value = result.address2 + result.address3;

          // 成功したら入力欄のエラー表示などを消す
          document.getElementById('prefecture').classList.remove('error');
          document.getElementById('city').classList.remove('error');
        } else {
          alert('該当する住所が見つかりませんでした。');
        }
      } catch (error) {
        console.error('住所検索エラー:', error);
        alert('住所検索に失敗しました。ネットワーク環境を確認してください。');
      }
    }

    function togglePasswordVisibility(button) {
      const targetId = button.dataset.target;
      const targetField = document.getElementById(targetId);
      if (targetField.type === 'password') {
        targetField.type = 'text';
        button.textContent = '🔒';
      } else {
        targetField.type = 'password';
        button.textContent = '👁️';
      }
    }
  </script>
</body>

</html>